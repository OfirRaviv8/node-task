name: CI-CD

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-deploy-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create kind cluster
        uses: helm/kind-action@v1.10.0
        with:
          cluster_name: ci-cluster

      - name: Build Docker image
        run: |
          docker build -t rm-service:ci .

      - name: Load image into kind
        run: |
          kind load docker-image rm-service:ci --name ci-cluster

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Deploy with Helm
        run: |
          helm upgrade --install rm-service ./rm-service-chart \
            --set image.repository=rm-service \
            --set image.tag=ci

      - name: Show resources
        run: |
          kubectl get pods -A
          kubectl get svc -A
          kubectl get ingress -A || true

      - name: Port-forward service and test endpoints
        run: |
          SVC=$(kubectl get svc -o jsonpath='{.items[0].metadata.name}')
          echo "Using service: $SVC"
          kubectl port-forward svc/$SVC 8000:80 &
          sleep 8
          curl -f http://localhost:8000/healthcheck
          curl -f http://localhost:8000/characters
